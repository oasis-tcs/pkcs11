## PKCS #12 password-based encryption/authentication mechanisms

The mechanisms in this section are for generating keys and IVs for performing
password-based encryption or authentication. The method used to generate keys
and IVs is based on a method that was specified in [PKCS #12].

We specify here a general method for producing various types of pseudo-random
bits from a password, _p_; a string of salt bits, _s_; and an iteration count,
_c_. The “type” of pseudo-random bits to be produced is identified by an
identification byte, _ID_, the meaning of which will be discussed later.

Let H be a hash function built around a compression function _f_: **Z**~2~^u^ ⨯
**Z**~2~^v^ → **Z**~2~^u^ (that is, H has a chaining variable and output of
length _u_ bits, and the message input to the compression function of H is _v_
bits). For MD2 and MD5, u=128 and v=512; for SHA-1, u=160 and v=512.

We assume here that _u_ and _v_ are both multiples of 8, as are the lengths in
bits of the password and salt strings and the number _n_ of pseudo-random bits
required. In addition, _u_ and _v_ are of course nonzero.

1. Construct a string, _D_ (the “diversifier”), by concatenating _v_/8 copies of
   _ID_.
2. Concatenate copies of the salt together to create a string _S_ of length
   _v_∙⎡_s_/_v_⎤ bits (the final copy of the salt may be truncated to create
   _S_). Note that if the salt is the empty string, then so is _S_.
3. Concatenate copies of the password together to create a string _P_ of length
   _v_∙⎡_p_/_v_⎤ bits (the final copy of the password may be truncated to create
   _P_). Note that if the password is the empty string, then so is _P_.
4. Set _I_=S||P to be the concatenation of _S_ and _P_.
5. Set j=⎡_n_/_u_⎤
6. For _i_=1, 2, …, _j_, do the following:
   a. Set _A_~i~=_H_^c^(_D_||_I_), the _c_^th^ hash of _D_||_I_. That is,
      compute the hash of _D_||_I_; comute the hash of that hash; etc.; continue
      in this fashion until a total of _c_ hases have been computed, each on the
      result of the previous hash.
   b. Concatenate copies of _A_~i~ to create a string _B_ of length _v_ bits
      (the final copy of _A_~i~ may be truncated to create _B_).
   c. Treating _I_ as a concatenation _I_~0~, _I_~1~, …, _I_~k-1~ of _v_-bit
      blocks, where _k_=⎡_s_/_v_⎤+⎡_p_/_v_⎤ modify _I_ by setting
      _I_~j~=(_I_~j~+_B_+1) mod 2^v^ for each _j_. To perform this addition,
      treat each _v_-bit block as a binary number represented most-significant
      bit first.
7. Concatenate _A_~1~, _A_~2~, …, _A_~j~ together to form a pseudo-random bit
   string, _A_.
8. Use the first _n_ bits of _A_ as the output of this entire process.

When the password-based encryption mechanisms presented in this section are used
to generate a key and IV (if needed) from a password, salt, and an iteration
count, the above algorithm is used. To generate a key, the identifier byte _ID_
is set to the value 1; to generate an IV, the identifier byte _ID_ is set to the
value 2.

When the password based authentication mechanism presented in this section is
used to generate a key from a password, salt, and an iteration count, the above
algorithm is used. The identifier byte _ID_ is set to the value 3.

### SHA-1-PBE for 3-key triple-DES-CBC

SHA-1-PBE for 3-key triple-DES-CBC, denoted **CKM_PBE_SHA1_DES3_EDE_CBC**, is a
mechanism used for generating a 3-key triple-DES secret key and IV from a
password and a salt value by using the SHA-1 digest algorithm and an iteration
count. The method used to generate the key and IV is described above. Each byte
of the key produced will have its low-order bit adjusted, if necessary, so that
a valid 3-key triple-DES key with proper parity bits is obtained.

It has a parameter, a **CK_PBE_PARAMS** structure. The parameter specifies the
input information for the key generation process and the location of the
application-supplied buffer which will receive the 8-byte IV generated by the
mechanism.

The key and IV produced by this mechanism will typically be used for performing
password-based encryption.

### SHA-1-PBE for 2-key triple-DES-CBC

SHA-1-PBE for 2-key triple-DES-CBC, denoted **CKM_PBE_SHA1_DES2_EDE_CBC**, is a
mechanism used for generating a 2-key triple-DES secret key and IV from a
password and a salt value by using the SHA-1 digest algorithm and an iteration
count. The method used to generate the key and IV is described above. Each byte
of the key produced will have its low-order bit adjusted, if necessary, so that
a valid 2-key triple-DES key with proper parity bits is obtained.

It has a parameter, a **CK_PBE_PARAMS** structure. The parameter specifies the
input information for the key generation process and the location of the
application-supplied buffer which will receive the 8-byte IV generated by the
mechanism.

The key and IV produced by this mechanism will typically be used for performing
password-based encryption.

### SHA-1-PBA for SHA-1-HMAC

SHA-1-PBA for SHA-1-HMAC, denoted **CKM_PBA_SHA1_WITH_SHA1_HMAC**, is a
mechanism used for generating a 160-bit generic secret key from a password and a
salt value by using the SHA-1 digest algorithm and an iteration count. The
method used to generate the key is described above.

It has a parameter, a **CK_PBE_PARAMS** structure. The parameter specifies the
input information for the key generation process. The parameter also has a field
to hold the location of an application-supplied buffer which will receive an IV;
for this mechanism, the contents of this field are ignored, since authentication
with SHA-1-HMAC does not require an IV.

The key generated by this mechanism will typically be used for computing a SHA-1
HMAC to perform password-based authentication (not _password-based encryption_).
At the time of this writing, this is primarily done to ensure the integrity of a
PKCS #12 PDU.
